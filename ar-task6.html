<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Ocean and Ship</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <video id="ocean" src="../videos/ocean.mp4" loop muted crossorigin="anonymous" playsinline style="display:none"></video>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-three.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        const markerIndex = new URLSearchParams(window.location.search).get('marker') || '0';
        document.addEventListener("DOMContentLoaded", async () => {
            const mindarThree = new window.MINDAR.IMAGE.MindARThree({
                container: document.body,
                imageTargetSrc: `../patterns/marker${markerIndex}.mind`
            });
            const {renderer, scene, camera} = mindarThree;
            const anchor = mindarThree.addAnchor(0);
            
            if (markerIndex === '0') {
                const video = document.getElementById("ocean");
                const texture = new THREE.VideoTexture(video);
                const plane = new THREE.Mesh(
                    new THREE.PlaneGeometry(1, 0.562),
                    new THREE.MeshBasicMaterial({map: texture})
                );
                anchor.group.add(plane);
                video.play();
            } else {
                const loader = new THREE.GLTFLoader();
                loader.load("../models/ship.glb", (gltf) => {
                    const ship = gltf.scene;
                    ship.scale.set(0.1, 0.1, 0.1);
                    anchor.group.add(ship);
                    
                    const raycaster = new THREE.Raycaster();
                    const mouse = new THREE.Vector2();
                    
                    window.addEventListener('click', (event) => {
                        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                        raycaster.setFromCamera(mouse, camera);
                        const intersects = raycaster.intersectObject(ship, true);
                        if (intersects.length > 0) {
                            const angle = (Math.random() * 45 + 45) * Math.PI / 180;
                            ship.rotateZ(angle);
                        }
                    });
                });
                
                const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
                scene.add(light);
            }
            
            await mindarThree.start();
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        });
    </script>
</body>
</html>