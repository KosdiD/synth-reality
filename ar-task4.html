<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Сцена 1: Танець Канекі</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@latest/dist/mindar-image-three.prod.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
                "GLTFLoader": "https://unpkg.com/three@0.150.1/examples/jsm/loaders/GLTFLoader.js"
            }
        }
    </script>

    <style>
        /* Стилі для розгортання AR-контейнера на весь екран */
        body { margin: 0; }
        .ar-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <div class="ar-container"></div>

    <script type="module">
        // Імпорт необхідних модулів з three.js
        import * as THREE from "three";
        import { GLTFLoader } from "GLTFLoader";

        document.addEventListener("DOMContentLoaded", () => {
            const startAR = async () => {
                const { MindARThree } = window.MINDAR.IMAGE;
                const mindarThree = new MindARThree({
                    container: document.querySelector(".ar-container"),
                    imageTargetSrc: "./markers/artem.mind", 
                });
                const { renderer, scene, camera } = mindarThree;

                // 2. Додавання освітлення
                // Навколишнє світло, щоб освітити модель з усіх боків
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                // Спрямоване світло, що імітує сонце і створює тіні
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(0, 5, 10);
                scene.add(directionalLight);

                // 3. Завантаження моделі
                const loader = new GLTFLoader();
                const clock = new THREE.Clock(); // Годинник для анімації
                let mixer; // Змінна для керування анімацією

                // 4. Створення якоря для маркера
                // Індекс 0 означає перший маркер у файлі .mind
                const anchor = mindarThree.addAnchor(0);

                loader.load(
                    "./models/kaneki_dance1.glb", // ШЛЯХ ДО ВАШОЇ ПЕРШОЇ МОДЕЛІ
                    (gltf) => {
                        // Модель успішно завантажена
                        const model = gltf.scene;
                        model.scale.set(0.7, 0.7, 0.7);
                        model.position.set(0, -1.2, 0);

                        // Додаємо модель до групи якоря. Тепер вона буде з'являтися на маркері.
                        anchor.group.add(model);

                        // Перевіряємо, чи є у моделі анімації
                        if (gltf.animations.length > 0) {
                            mixer = new THREE.AnimationMixer(model);
                            // Запускаємо першу анімацію
                            const action = mixer.clipAction(gltf.animations[0]);
                            action.play();
                        }
                    },
                    undefined, // Функція для відстеження прогресу завантаження (не використовується)
                    (error) => {
                        // Обробка помилки, якщо модель не завантажилася
                        console.error("Помилка завантаження моделі:", error);
                    }
                );
                
                // 5. Запуск AR
                await mindarThree.start();

                // 6. Цикл рендерингу
                renderer.setAnimationLoop(() => {
                    const delta = clock.getDelta(); // Час, що минув з попереднього кадру
                    // Оновлюємо анімацію, якщо вона є
                    if (mixer) {
                        mixer.update(delta);
                    }
                    // Рендеримо сцену
                    renderer.render(scene, camera);
                });
            };

            startAR();
        });
    </script>
</body>
</html>
